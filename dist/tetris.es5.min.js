"use strict";var _createClass=function(){function i(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,r){return e&&i(t.prototype,e),r&&i(t,r),t}}();function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Tetris=function(){function l(t){this._seed=t%2147483647,this.nextInt=function(){return this._seed=16807*this._seed%2147483647},this.nextInRange=function(t,e){return e=void 0===e?0:e,--t,Math.floor(e+this.nextFloat()*(t+1-e))},this.nextFloat=function(){return(this.nextInt()-1)/2147483646},this._seed<=0&&(this._seed+=2147483646)}function n(){1===arguments.length&&arguments[0]instanceof n?this._copyingConstructor.apply(this,arguments):this._defaultConstructor.apply(this,arguments)}function f(){this.bricks=[],this.isFrozen=!1,1===arguments.length&&arguments[0]instanceof f?this._copyingConstructor.apply(this,arguments):this._defaultConstructor.apply(this,arguments)}function p(s,c,h,u,t){var l=this;this.width=c,this.height=h,this.game=s;var e="rgb(69,90,100)",r="rgba(69,90,100,0.12)";this.spawnShape=function(){return new f(c,u,t)},this.activeShape=this.spawnShape(),this.staticBricks=[],this.drawStaticBricks=function(e){l.staticBricks.forEach(function(t){return t.draw(e)})},this.drawBackground=function(t){t.fillStyle=s.turboMode?r:e,t.fillRect(0,0,c,h)},this.drawReplay=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("REPLAY...",0,20)},this.drawScore=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("Score: "+s.playerScore.get(),0,10)},this.isFull=function(){return l.staticBricks.some(function(t){return t.y<2*u})},this.checkFilledRegions=function(){for(var t=[],r=void 0,i=0,e=function(e){r=l.staticBricks.filter(function(t){return t.y===e}),t.push({bricks:r,isFull:r.length===c/u}),i+=r.length},n=h-u;i!==l.staticBricks.length;n-=u)e(n);var o=[],a=0;for(n=0;n<t.length;++n)t[n].isFull?(t[n].bricks=[],++a,s.playerScore.add(a)):t[n].bricks.forEach(function(t){t.y+=a*u}),o=o.concat(t[n].bricks);l.staticBricks=o},this.checkCollisions=function(t){var r=Object.seal({left:!1,right:!1,bottom:!1}),i=function(t,i){return function(e){if("board"!==t){var r=!1;return l.staticBricks.forEach(function(t){switch(i){case"bottom":r=r||e.y===t.y-u&&e.x===t.x;break;case"left":r=r||e.y===t.y&&e.x-u===t.x;break;case"right":r=r||e.y===t.y&&e.x+u===t.x}}),r}switch(i){case"bottom":return e.y===h-u;case"left":return 0===e.x;case"right":return e.x===c-u}}};l.activeShape.bricks.forEach(function(e){["bottom","left","right"].forEach(function(t){(i("board",t)(e)||i("static",t)(e))&&(r[t]=!0)})}),t(r)}}n.prototype._defaultConstructor=function(t,e,r,i){this.x=t,this.y=e,this.rgb=r,this.size=i},n.prototype._copyingConstructor=function(t){this.x=t.x,this.y=t.y,this.rgb=t.rgb,this.size=t.size},n.prototype.draw=function(t){var e,i,r,n;t.fillStyle=this.rgb,t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.size-1,this.y),t.lineTo(this.x,this.y+this.size-1),t.closePath(),t.fill(),t.fillStyle=(e=this.rgb,i=.9,r=/rgb\((\d+) ?, ?(\d+) ?, ?(\d+)\)/g.exec(e),(n=[r[1],r[2],r[3]]).forEach(function(t,e,r){r[e]=Math.floor(t*i)}),"rgb("+n[0]+","+n[1]+","+n[2]+")"),t.beginPath(),t.moveTo(this.x+this.size-1,this.y),t.lineTo(this.x,this.y+this.size-1),t.lineTo(this.x,this.y+this.size-1),t.lineTo(this.x+this.size-1,this.y+this.size-1),t.closePath(),t.fill()},f.prototype._copyingConstructor=function(t){this.color=t.color,this.type=t.type,this.orientaion=t.orientaion;for(var e=0;e<4;++e)this.bricks.push(new n(t.bricks[e]))},f.prototype._defaultConstructor=function(t,e,r){this.startX=t/2,this.startY=e,this.color=r.nextInRange(f.prototype.parameters.colors.length),this.type=r.nextInRange(f.prototype.parameters.types.length),this.orientaion=r.nextInRange(f.prototype.parameters.orientations.length);for(var i=0;i<4;++i)this.bricks.push(new n(this.startX,this.startY,f.prototype.parameters.colors[this.color].rgb,e));this.applyOrientation()},f.prototype.draw=function(e){this.bricks.forEach(function(t){return t.draw(e)})},f.prototype.applyOrientation=function(){for(var t=f.prototype.parameters.types[this.type].matrix,e=f.prototype.parameters.orientations[this.orientaion].matrix,r=[],i=0;i<3;++i){r[i]=[];for(var n=0;n<2;++n)for(var o=r[i][n]=0;o<2;++o)r[i][n]+=t[i][o]*e[o][n]}for(var a=this.bricks[0],s=0;s<3;++s)this.bricks[s+1].x=a.x+r[s][0]*brickSize,this.bricks[s+1].y=a.y+r[s][1]*brickSize;return this},f.prototype.parameters=Object.freeze({types:[{name:"I",matrix:[[0,-1],[0,1],[0,2]]},{name:"O",matrix:[[0,1],[1,0],[1,1]]},{name:"Z",matrix:[[0,-1],[-1,0],[1,-1]]},{name:"S",matrix:[[-1,-1],[0,-1],[1,0]]},{name:"T",matrix:[[1,0],[-1,0],[0,1]]},{name:"J",matrix:[[1,0],[-1,0],[-1,1]]},{name:"L",matrix:[[1,0],[-1,0],[-1,-1]]}],orientations:[{angle:0,matrix:[[1,0],[0,1]]},{angle:90,matrix:[[0,-1],[1,0]]},{angle:180,matrix:[[-1,0],[0,-1]]},{angle:270,matrix:[[0,1],[-1,0]]}],colors:[{name:"orange",rgb:"rgb(239,108,0)"},{name:"red",rgb:"rgb(211,47,47)"},{name:"green",rgb:"rgb(76,175,80)"},{name:"blue",rgb:"rgb(33,150,243)"},{name:"yellow",rgb:"rgb(255,235,59)"},{name:"cyan",rgb:"rgb(0,188,212)"},{name:"pink",rgb:"rgb(233,30,99)"},{name:"white",rgb:"rgb(224,224,224)"}]}),f.prototype.actions=Object.freeze({ROTATE:"rotate",MOVE_LEFT:"move-left",MOVE_RIGHT:"move-right",FALL:"fall",DROP:"drop"});var o=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){var e=new f(t.activeShape);if("O"!==f.prototype.parameters.types[e.type].name){e.orientaion=3===e.orientaion?0:++e.orientaion,e.applyOrientation();for(var r=0;r<4;++r){for(var i=0;i<t.staticBricks.length;++i)if(e.bricks[r].x===t.staticBricks[i].x&&e.bricks[r].y===t.staticBricks[i].y)return;if(e.bricks[r].x>=t.width||e.bricks[r].x<=0||e.bricks[r].y>=t.height)return}}t.activeShape=e}}]),t}(),a=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){var r=this;t.checkCollisions(function(t){if(!t.left)for(var e=0;e<4;++e)r.bricks[e].x-=brickSize})}}]),t}(),s=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){var r=this;t.checkCollisions(function(t){if(!t.right)for(var e=0;e<4;++e)r.bricks[e].x+=brickSize})}}]),t}(),c=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){t.game.turboMode=!0}}]),t}();function y(t,e,r,i){var n;return _defineProperty(n={},t,new a),_defineProperty(n,e,new s),_defineProperty(n,r,new o),_defineProperty(n,i,new c),n}function d(i){var n=Object.seal(Object.assign({Escape:!1,Enter:!1,anyKey:!1},i));Object.keys(n).forEach(function(t){return n[t]=!1});var o={},a=[];function t(t){var e="keydown"===t.type,r=t.code;(n.anyKey=e)&&void 0!==o.anyKey&&o.anyKey(r),void 0!==n[r]&&(t.preventDefault(),(n[r]=e)&&(r in i&&a.push(r),void 0!==o[r]&&o[r]()))}return{keys:n,keyMap:i,keyQueue:a,start:function(){addEventListener("keyup",t),addEventListener("keydown",t)},stop:function(){removeEventListener("keyup",t),removeEventListener("keydown",t)},setCallback:function(t,e){o[t]=e}}}function b(t,e){var r=[],i=1/0,n=function(){t.setCallback("anyKey",function(t){r.push({key:t,frame:e.getFrameCount()})}),t.setCallback("Escape",function(){t.stop(),i=e.getFrameCount(),o(),r.pop(),a(),e.restart(),e.setRandomSeed(+new Date)})},o=function(){t.setCallback("anyKey",void 0),t.setCallback("Escape",void 0)},a=function(){e.onProceed=function(){e.getFrameCount()!==i?(e.drawReplay(),r.length&&e.getFrameCount()===r[0].frame&&t.keyQueue.push(r.shift().key)):(e.onProceed=void 0,t.start(),n(),e.restart())}};return{tape:r,lastFrame:i,start:n,stop:o,play:a}}var k=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){this.bricks.forEach(function(t){t.y+=brickSize})}}]),t}();return function(t){var e,i,n=this,o=t.context,r=[new y("ArrowLeft","ArrowRight","ArrowUp","ArrowDown"),new y("KeyA","KeyD","KeyW","KeyS"),new y("KeyH","KeyL","KeyK","KeyJ")],a=new d(Object.assign.apply(Object,r)),s=new b(a,this);a.start(),s.start(),this.randomSeed=+new Date,this.random=new l(this.randomSeed),this.playerScore=(i=[149,49,39,9,e=0],{get:function(){return e},set:function(r){e=r,i.some(function(t,e){if(t<=r)return u=5-e,!0})},add:function(t){this.set(e+t)}});var c=new p(this,t.board.boardWidth,t.board.boardHeight,t.board.brickSize,this.random),h=0;this.onProceed=void 0;var u=1;this.turboMode=!1,this.drawReplay=function(){c.drawReplay(o)},this.getFrameCount=function(){return h},this.restart=function(){n.random=new l(n.randomSeed),n.playerScore.set(0),h=0,u=1,n.turboMode=!1,c=new p(n,t.board.boardWidth,t.board.boardHeight,t.board.brickSize,n.random)},this.setRandomSeed=function(t){n.randomSeed=t},this.proceed=function(){var t,e;if(++h,c.drawBackground(o),void 0!==n.onProceed&&n.onProceed(),t=a.keyQueue.shift(),(e=a.keyMap[t])&&e.execute.call(c.activeShape,c),c.checkCollisions(function(t){c.activeShape.isFrozen=t.bottom}),c.activeShape.isFrozen){for(var r=0;r<4;++r)c.staticBricks.push(c.activeShape.bricks.pop());c.checkFilledRegions(),n.turboMode=!1,c.activeShape=c.spawnShape(),c.isFull()&&n.restart()}else(n.turboMode||h%[null,27,24,16,12,8][u]==0)&&(new k).execute.call(c.activeShape,c),c.activeShape.draw(o);c.drawStaticBricks(o),c.drawScore(o)},requestAnimationFrame(function t(){n.proceed(),requestAnimationFrame(t)})}}();