"use strict";var _createClass=function(){function i(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,r){return e&&i(t.prototype,e),r&&i(t,r),t}}();function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Tetris=function(){function f(t){this._seed=t%2147483647,this.nextInt=function(){return this._seed=16807*this._seed%2147483647},this.nextInRange=function(t,e){return e=void 0===e?0:e,--t,Math.floor(e+this.nextFloat()*(t+1-e))},this.nextFloat=function(){return(this.nextInt()-1)/2147483646},this._seed<=0&&(this._seed+=2147483646)}var i=function(){function n(t,e,r,i){_classCallCheck(this,n),this.x=t,this.y=e,this.rgb=r,this.size=i}return _createClass(n,[{key:"draw",value:function(t){var e,i,r,n;t.fillStyle=this.rgb,t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.size-1,this.y),t.lineTo(this.x,this.y+this.size-1),t.closePath(),t.fill(),t.fillStyle=(e=this.rgb,i=.9,r=/rgb\((\d+) ?, ?(\d+) ?, ?(\d+)\)/g.exec(e),(n=[r[1],r[2],r[3]]).forEach(function(t,e,r){r[e]=Math.floor(t*i)}),"rgb("+n[0]+","+n[1]+","+n[2]+")"),t.beginPath(),t.moveTo(this.x+this.size-1,this.y),t.lineTo(this.x,this.y+this.size-1),t.lineTo(this.x,this.y+this.size-1),t.lineTo(this.x+this.size-1,this.y+this.size-1),t.closePath(),t.fill()}}]),n}();function l(t,c,e){var h=this;this.startX=t/2,this.startY=c,this.isFrozen=!1,this.color=e.nextInRange(l.prototype.parameters.colors.length),this.type=e.nextInRange(l.prototype.parameters.types.length),this.orientaion=e.nextInRange(l.prototype.parameters.orientations.length),this.bricks=[],this.draw=function(e){h.bricks.forEach(function(t){return t.draw(e)})},this.performAction=function(t){switch(t){case l.prototype.actions.ROTATE:"O"!==l.prototype.parameters.types[h.type].name&&(h.orientaion=3===h.orientaion?0:++h.orientaion,h.applyOrientation());break;case l.prototype.actions.FALL:h.bricks.forEach(function(t){t.y+=c});break;case l.prototype.actions.MOVE_RIGHT:case l.prototype.actions.MOVE_LEFT:for(var e=0;e<4;++e)t===l.prototype.actions.MOVE_LEFT?h.bricks[e].x-=c:h.bricks[e].x+=c;break;case l.prototype.actions.DROP:}return h},this.applyOrientation=function(){for(var t=l.prototype.parameters.types[h.type].matrix,e=l.prototype.parameters.orientations[h.orientaion].matrix,r=[],i=0;i<3;++i){r[i]=[];for(var n=0;n<2;++n)for(var o=r[i][n]=0;o<2;++o)r[i][n]+=t[i][o]*e[o][n]}for(var a=h.bricks[0],s=0;s<3;++s)h.bricks[s+1].x=a.x+r[s][0]*c,h.bricks[s+1].y=a.y+r[s][1]*c;return h};for(var r=0;r<4;++r)this.bricks.push(new i(this.startX,this.startY,l.prototype.parameters.colors[this.color].rgb,c));return this.applyOrientation(),this}function y(s,c,h,p,t){var u=this,e="rgb(69,90,100)",r="rgba(69,90,100,0.12)";this.spawnShape=function(){return new l(c,p,t)},this.activeShape=this.spawnShape(),this.staticBricks=[],this.drawStaticBricks=function(e){u.staticBricks.forEach(function(t){return t.draw(e)})},this.drawBackground=function(t){t.fillStyle=s.turboMode?r:e,t.fillRect(0,0,c,h)},this.drawReplay=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("REPLAY...",0,20)},this.drawScore=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("Score: "+s.playerScore.get(),0,10)},this.isFull=function(){return u.staticBricks.some(function(t){return t.y<2*p})},this.checkFilledRegions=function(){for(var t=[],r=void 0,i=0,e=function(e){r=u.staticBricks.filter(function(t){return t.y===e}),t.push({bricks:r,isFull:r.length===c/p}),i+=r.length},n=h-p;i!==u.staticBricks.length;n-=p)e(n);var o=[],a=0;for(n=0;n<t.length;++n)t[n].isFull?(t[n].bricks=[],++a,s.playerScore.add(a)):t[n].bricks.forEach(function(t){t.y+=a*p}),o=o.concat(t[n].bricks);u.staticBricks=o},this.checkCollisions=function(t){var r=Object.seal({left:!1,right:!1,bottom:!1}),i=function(t,i){return function(e){if("board"!==t){var r=!1;return u.staticBricks.forEach(function(t){switch(i){case"bottom":r=r||e.y===t.y-p&&e.x===t.x;break;case"left":r=r||e.y===t.y&&e.x-p===t.x;break;case"right":r=r||e.y===t.y&&e.x+p===t.x}}),r}switch(i){case"bottom":return e.y===h-p;case"left":return 0===e.x;case"right":return e.x===c-p}}};u.activeShape.bricks.forEach(function(e){["bottom","left","right"].forEach(function(t){(i("board",t)(e)||i("static",t)(e))&&(r[t]=!0)})}),t(r)}}function b(t,e,r,i){var n;return _defineProperty(n={},t,l.prototype.actions.MOVE_LEFT),_defineProperty(n,e,l.prototype.actions.MOVE_RIGHT),_defineProperty(n,r,l.prototype.actions.ROTATE),_defineProperty(n,i,l.prototype.actions.DROP),n}function d(i){var n=Object.seal(Object.assign({Escape:!1,Enter:!1,anyKey:!1},i));Object.keys(n).forEach(function(t){return n[t]=!1});var o={},a=[];function t(t){var e="keydown"===t.type,r=t.code;(n.anyKey=e)&&void 0!==o.anyKey&&o.anyKey(r),void 0!==n[r]&&(t.preventDefault(),(n[r]=e)&&(r in i&&a.push(r),void 0!==o[r]&&o[r]()))}return{keys:n,keyMap:i,keyQueue:a,start:function(){addEventListener("keyup",t),addEventListener("keydown",t)},stop:function(){removeEventListener("keyup",t),removeEventListener("keydown",t)},setCallback:function(t,e){o[t]=e}}}function m(t,e){var r=[],i=1/0,n=function(){t.setCallback("anyKey",function(t){r.push({key:t,frame:e.getFrameCount()})}),t.setCallback("Escape",function(){t.stop(),i=e.getFrameCount(),o(),r.pop(),a(),e.restart(),e.setRandomSeed(+new Date)})},o=function(){t.setCallback("anyKey",void 0),t.setCallback("Escape",void 0)},a=function(){e.onProceed=function(){e.getFrameCount()!==i?(e.drawReplay(),r.length&&e.getFrameCount()===r[0].frame&&t.keyQueue.push(r.shift().key)):(e.onProceed=void 0,t.start(),n(),e.restart())}};return{tape:r,lastFrame:i,start:n,stop:o,play:a}}return l.prototype.parameters=Object.freeze({types:[{name:"I",matrix:[[0,-1],[0,1],[0,2]]},{name:"O",matrix:[[0,1],[1,0],[1,1]]},{name:"Z",matrix:[[0,-1],[-1,0],[1,-1]]},{name:"S",matrix:[[-1,-1],[0,-1],[1,0]]},{name:"T",matrix:[[1,0],[-1,0],[0,1]]},{name:"J",matrix:[[1,0],[-1,0],[-1,1]]},{name:"L",matrix:[[1,0],[-1,0],[-1,-1]]}],orientations:[{angle:0,matrix:[[1,0],[0,1]]},{angle:90,matrix:[[0,-1],[1,0]]},{angle:180,matrix:[[-1,0],[0,-1]]},{angle:270,matrix:[[0,1],[-1,0]]}],colors:[{name:"orange",rgb:"rgb(239,108,0)"},{name:"red",rgb:"rgb(211,47,47)"},{name:"green",rgb:"rgb(76,175,80)"},{name:"blue",rgb:"rgb(33,150,243)"},{name:"yellow",rgb:"rgb(255,235,59)"},{name:"cyan",rgb:"rgb(0,188,212)"},{name:"pink",rgb:"rgb(233,30,99)"},{name:"white",rgb:"rgb(224,224,224)"}]}),l.prototype.actions=Object.freeze({ROTATE:"rotate",MOVE_LEFT:"move-left",MOVE_RIGHT:"move-right",FALL:"fall",DROP:"drop"}),function(n){var e,t,r=this,i=n.context,o=[new b("ArrowLeft","ArrowRight","ArrowUp","ArrowDown"),new b("KeyA","KeyD","KeyW","KeyS"),new b("KeyH","KeyL","KeyK","KeyJ")],a=new d(Object.assign.apply(Object,o)),s=new m(a,this);a.start(),s.start(),this.randomSeed=+new Date,this.random=new f(this.randomSeed),this.playerScore=(t=[149,49,39,9,e=0],{get:function(){return e},set:function(r){e=r,t.some(function(t,e){if(t<=r)return p=5-e,!0})},add:function(t){this.set(e+t)}});var c=new y(this,n.board.boardWidth,n.board.boardHeight,n.board.brickSize,this.random),h=0;this.onProceed=void 0;var p=1;this.turboMode=!1,this.drawReplay=function(){c.drawReplay(i)},this.getFrameCount=function(){return h},this.restart=function(){r.random=new f(r.randomSeed),r.playerScore.set(0),h=0,p=1,r.turboMode=!1,c=new y(r,n.board.boardWidth,n.board.boardHeight,n.board.brickSize,r.random)},this.setRandomSeed=function(t){r.randomSeed=t};var u=function(e){c.checkCollisions(function(t){switch(c.activeShape.isFrozen=t.bottom,!0){case e===l.prototype.actions.ROTATE&&function(){var t=c.spawnShape();t.orientaion=c.activeShape.orientaion,t.type=c.activeShape.type;for(var e=0;e<4;++e)Object.assign(t.bricks[e],c.activeShape.bricks[e]);t.performAction(l.prototype.actions.ROTATE);for(var r=0;r<4;++r){for(var i=0;i<c.staticBricks.length;++i)if(t.bricks[r].x===c.staticBricks[i].x&&t.bricks[r].y===c.staticBricks[i].y)return!0;if(t.bricks[r].x>=n.board.boardWidth||t.bricks[r].x<=0||t.bricks[r].y>=n.board.boardHeight)return!0}return!1}():case e===l.prototype.actions.MOVE_RIGHT&&t.right:case e===l.prototype.actions.MOVE_LEFT&&t.left:case e===l.prototype.actions.FALL&&t.bottom:case e===l.prototype.actions.DROP&&t.bottom:break;default:e===l.prototype.actions.DROP&&(r.turboMode=!0),c.activeShape.performAction(e)}})};this.proceed=function(){var t;if(++h,c.drawBackground(i),void 0!==r.onProceed&&r.onProceed(),t=a.keyQueue.shift(),u(a.keyMap[t]),c.checkCollisions(function(t){c.activeShape.isFrozen=t.bottom}),c.activeShape.isFrozen){for(var e=0;e<4;++e)c.staticBricks.push(c.activeShape.bricks.pop());c.checkFilledRegions(),r.turboMode=!1,c.activeShape=c.spawnShape(),c.isFull()&&r.restart()}else(r.turboMode||h%[null,27,24,16,12,8][p]==0)&&u(l.prototype.actions.FALL),c.activeShape.draw(i);c.drawStaticBricks(i),c.drawScore(i)},requestAnimationFrame(function t(){r.proceed(),requestAnimationFrame(t)})}}();