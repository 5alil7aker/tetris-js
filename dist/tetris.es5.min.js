"use strict";var _createClass=function(){function r(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t}}();function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Tetris=function(){function l(t){this._seed=t%2147483647,this.nextInt=function(){return this._seed=16807*this._seed%2147483647},this.nextInRange=function(t,e){return e=void 0===e?0:e,--t,Math.floor(e+this.nextFloat()*(t+1-e))},this.nextFloat=function(){return(this.nextInt()-1)/2147483646},this._seed<=0&&(this._seed+=2147483646)}function n(){1===arguments.length&&arguments[0]instanceof n?this._copyingConstructor.apply(this,arguments):this._defaultConstructor.apply(this,arguments)}function c(){this.bricks=[],this.isFrozen=!1,1===arguments.length&&arguments[0]instanceof c?this._copyingConstructor.apply(this,arguments):this._defaultConstructor.apply(this,arguments)}function f(t,e,i,r,n){this.staticBricks=[],this.width=e,this.height=i,this.brickSize=r,this.random=n,this.activeShape=this.spawnShape(),this.game=t,this.colors={normal:"rgb(69,90,100)",turbo:"rgba(69,90,100,0.12)"}}n.prototype._defaultConstructor=function(t,e,i,r){this.x=t,this.y=e,this.rgb=i,this.size=r},n.prototype._copyingConstructor=function(t){this.x=t.x,this.y=t.y,this.rgb=t.rgb,this.size=t.size},n.prototype.draw=function(t){var e,r,i,n;t.fillStyle=this.rgb,t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.size-1,this.y),t.lineTo(this.x,this.y+this.size-1),t.closePath(),t.fill(),t.fillStyle=(e=this.rgb,r=.9,i=/rgb\((\d+) ?, ?(\d+) ?, ?(\d+)\)/g.exec(e),(n=[i[1],i[2],i[3]]).forEach(function(t,e,i){i[e]=Math.floor(t*r)}),"rgb("+n[0]+","+n[1]+","+n[2]+")"),t.beginPath(),t.moveTo(this.x+this.size-1,this.y),t.lineTo(this.x,this.y+this.size-1),t.lineTo(this.x,this.y+this.size-1),t.lineTo(this.x+this.size-1,this.y+this.size-1),t.closePath(),t.fill()},c.prototype._copyingConstructor=function(t){this.color=t.color,this.type=t.type,this.startX=t.startX,this.startY=t.startY,this.orientaion=t.orientaion;for(var e=0;e<4;++e)this.bricks.push(new n(t.bricks[e]))},c.prototype._defaultConstructor=function(t,e,i){this.startX=t/2,this.startY=e,this.color=i.nextInRange(c.prototype.parameters.colors.length),this.type=i.nextInRange(c.prototype.parameters.types.length),this.orientaion=i.nextInRange(c.prototype.parameters.orientations.length);for(var r=0;r<4;++r)this.bricks.push(new n(this.startX,this.startY,c.prototype.parameters.colors[this.color].rgb,e));this.applyOrientation()},c.prototype.draw=function(e){this.bricks.forEach(function(t){return t.draw(e)})},c.prototype.applyOrientation=function(){for(var t=c.prototype.parameters.types[this.type].matrix,e=c.prototype.parameters.orientations[this.orientaion].matrix,i=[],r=0;r<3;++r){i[r]=[];for(var n=0;n<2;++n)for(var o=i[r][n]=0;o<2;++o)i[r][n]+=t[r][o]*e[o][n]}for(var a=this.bricks[0],s=0;s<3;++s)this.bricks[s+1].x=a.x+i[s][0]*this.startY,this.bricks[s+1].y=a.y+i[s][1]*this.startY;return this},c.prototype.parameters=Object.freeze({types:[{name:"I",matrix:[[0,-1],[0,1],[0,2]]},{name:"O",matrix:[[0,1],[1,0],[1,1]]},{name:"Z",matrix:[[0,-1],[-1,0],[1,-1]]},{name:"S",matrix:[[-1,-1],[0,-1],[1,0]]},{name:"T",matrix:[[1,0],[-1,0],[0,1]]},{name:"J",matrix:[[1,0],[-1,0],[-1,1]]},{name:"L",matrix:[[1,0],[-1,0],[-1,-1]]}],orientations:[{angle:0,matrix:[[1,0],[0,1]]},{angle:90,matrix:[[0,-1],[1,0]]},{angle:180,matrix:[[-1,0],[0,-1]]},{angle:270,matrix:[[0,1],[-1,0]]}],colors:[{name:"orange",rgb:"rgb(239,108,0)"},{name:"red",rgb:"rgb(211,47,47)"},{name:"green",rgb:"rgb(76,175,80)"},{name:"blue",rgb:"rgb(33,150,243)"},{name:"yellow",rgb:"rgb(255,235,59)"},{name:"cyan",rgb:"rgb(0,188,212)"},{name:"pink",rgb:"rgb(233,30,99)"},{name:"white",rgb:"rgb(224,224,224)"}]}),c.prototype.actions=Object.freeze({ROTATE:"rotate",MOVE_LEFT:"move-left",MOVE_RIGHT:"move-right",FALL:"fall",DROP:"drop"}),f.prototype.drawBackground=function(t){t.fillStyle=this.game.turboMode?this.colors.turbo:this.colors.normal,t.fillRect(0,0,this.width,this.height)},f.prototype.drawStaticBricks=function(e){this.staticBricks.forEach(function(t){return t.draw(e)})},f.prototype.drawReplay=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("REPLAY...",0,20)},f.prototype.drawScore=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("Score: "+this.game.playerScore.get(),0,10)},f.prototype.spawnShape=function(){return new c(this.width,this.brickSize,this.random)},f.prototype.isFull=function(){var e=this;return this.staticBricks.some(function(t){return t.y<2*e.brickSize})},f.prototype.checkFilledRegions=function(){for(var i=this,t=[],r=void 0,n=0,e=function(e){r=i.staticBricks.filter(function(t){return t.y===e}),t.push({bricks:r,isFull:r.length===i.width/i.brickSize}),n+=r.length},o=this.height-this.brickSize;n!==this.staticBricks.length;o-=this.brickSize)e(o);var a=[],s=0;for(o=0;o<t.length;++o)t[o].isFull?(t[o].bricks=[],++s,this.game.playerScore.add(s)):t[o].bricks.forEach(function(t){t.y+=s*i.brickSize}),a=a.concat(t[o].bricks);this.staticBricks=a},f.prototype.checkCollisions=function(t){var n=this,i=Object.seal({left:!1,right:!1,bottom:!1}),r=function(t,r){return function(e){if("board"!==t){var i=!1;return n.staticBricks.forEach(function(t){switch(r){case"bottom":i=i||e.y===t.y-n.brickSize&&e.x===t.x;break;case"left":i=i||e.y===t.y&&e.x-n.brickSize===t.x;break;case"right":i=i||e.y===t.y&&e.x+n.brickSize===t.x}}),i}switch(r){case"bottom":return e.y===n.height-n.brickSize;case"left":return 0===e.x;case"right":return e.x===n.width-n.brickSize}}};this.activeShape.bricks.forEach(function(e){["bottom","left","right"].forEach(function(t){(r("board",t)(e)||r("static",t)(e))&&(i[t]=!0)})}),t(i)};var o=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){var e=new c(t.activeShape);if("O"!==c.prototype.parameters.types[e.type].name){e.orientaion=3===e.orientaion?0:++e.orientaion,e.applyOrientation();for(var i=0;i<4;++i){for(var r=0;r<t.staticBricks.length;++r)if(e.bricks[i].x===t.staticBricks[r].x&&e.bricks[i].y===t.staticBricks[r].y)return;if(e.bricks[i].x>=t.width||e.bricks[i].x<=0||e.bricks[i].y>=t.height)return}}t.activeShape=e}}]),t}(),a=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){var i=this;t.checkCollisions(function(t){if(!t.left)for(var e=0;e<4;++e)i.bricks[e].x-=brickSize})}}]),t}(),s=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){var i=this;t.checkCollisions(function(t){if(!t.right)for(var e=0;e<4;++e)i.bricks[e].x+=brickSize})}}]),t}(),h=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(t){t.game.turboMode=!0}}]),t}();function p(t,e,i,r){var n;return _defineProperty(n={},t,new a),_defineProperty(n,e,new s),_defineProperty(n,i,new o),_defineProperty(n,r,new h),n}function y(r){var n=Object.seal(Object.assign({Escape:!1,Enter:!1,anyKey:!1},r));Object.keys(n).forEach(function(t){return n[t]=!1});var o={},a=[];function t(t){var e="keydown"===t.type,i=t.code;(n.anyKey=e)&&void 0!==o.anyKey&&o.anyKey(i),void 0!==n[i]&&(t.preventDefault(),(n[i]=e)&&(i in r&&a.push(i),void 0!==o[i]&&o[i]()))}return{keys:n,keyMap:r,keyQueue:a,start:function(){addEventListener("keyup",t),addEventListener("keydown",t)},stop:function(){removeEventListener("keyup",t),removeEventListener("keydown",t)},setCallback:function(t,e){o[t]=e}}}function b(t,e){var i=[],r=1/0,n=function(){t.setCallback("anyKey",function(t){i.push({key:t,frame:e.getFrameCount()})}),t.setCallback("Escape",function(){t.stop(),r=e.getFrameCount(),o(),i.pop(),a(),e.restart(),e.setRandomSeed(+new Date)})},o=function(){t.setCallback("anyKey",void 0),t.setCallback("Escape",void 0)},a=function(){e.onProceed=function(){e.getFrameCount()!==r?(e.drawReplay(),i.length&&e.getFrameCount()===i[0].frame&&t.keyQueue.push(i.shift().key)):(e.onProceed=void 0,t.start(),n(),e.restart())}};return{tape:i,lastFrame:r,start:n,stop:o,play:a}}var d=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"execute",value:function(e){this.bricks.forEach(function(t){t.y+=e.brickSize})}}]),t}();return function(t){var e,r,n=this,o=t.context,i=[new p("ArrowLeft","ArrowRight","ArrowUp","ArrowDown"),new p("KeyA","KeyD","KeyW","KeyS"),new p("KeyH","KeyL","KeyK","KeyJ")],a=new y(Object.assign.apply(Object,i)),s=new b(a,this);a.start(),s.start(),this.randomSeed=+new Date,this.random=new l(this.randomSeed),this.playerScore=(r=[149,49,39,9,e=0],{get:function(){return e},set:function(i){e=i,r.some(function(t,e){if(t<=i)return u=5-e,!0})},add:function(t){this.set(e+t)}});var c=new f(this,t.board.boardWidth,t.board.boardHeight,t.board.brickSize,this.random),h=0;this.onProceed=void 0;var u=1;this.turboMode=!1,this.drawReplay=function(){c.drawReplay(o)},this.getFrameCount=function(){return h},this.restart=function(){n.random=new l(n.randomSeed),n.playerScore.set(0),h=0,u=1,n.turboMode=!1,c=new f(n,t.board.boardWidth,t.board.boardHeight,t.board.brickSize,n.random)},this.setRandomSeed=function(t){n.randomSeed=t},this.proceed=function(){var t,e;if(++h,c.drawBackground(o),void 0!==n.onProceed&&n.onProceed(),t=a.keyQueue.shift(),(e=a.keyMap[t])&&e.execute.call(c.activeShape,c),c.checkCollisions(function(t){c.activeShape.isFrozen=t.bottom}),c.activeShape.isFrozen){for(var i=0;i<4;++i)c.staticBricks.push(c.activeShape.bricks.pop());c.checkFilledRegions(),n.turboMode=!1,c.activeShape=c.spawnShape(),c.isFull()&&n.restart()}else(n.turboMode||h%[null,27,24,16,12,8][u]==0)&&(new d).execute.call(c.activeShape,c),c.activeShape.draw(o);c.drawStaticBricks(o),c.drawScore(o)},requestAnimationFrame(function t(){n.proceed(),requestAnimationFrame(t)})}}();