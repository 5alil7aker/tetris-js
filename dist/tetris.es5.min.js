"use strict";function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var Tetris=function(){function f(t){this._seed=t%2147483647,this.nextInt=function(){return this._seed=16807*this._seed%2147483647},this.nextInRange=function(t,e){return e=void 0===e?0:e,--t,Math.floor(e+this.nextFloat()*(t+1-e))},this.nextFloat=function(){return(this.nextInt()-1)/2147483646},this._seed<=0&&(this._seed+=2147483646)}function o(t,e,r,i){var a=this;this.x=t,this.y=e,this.rgb=r,this.draw=function(t){var e,o,r,n;t.fillStyle=a.rgb,t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(a.x+i-1,a.y),t.lineTo(a.x,a.y+i-1),t.closePath(),t.fill(),t.fillStyle=(e=a.rgb,o=.9,r=/rgb\((\d+),(\d+),(\d+)\)/g.exec(e),(n=[r[1],r[2],r[3]]).forEach(function(t,e,r){r[e]=Math.floor(t*o)}),"rgb("+n[0]+", "+n[1]+", "+n[2]+")"),t.beginPath(),t.moveTo(a.x+i-1,a.y),t.lineTo(a.x,a.y+i-1),t.lineTo(a.x,a.y+i-1),t.lineTo(a.x+i-1,a.y+i-1),t.closePath(),t.fill()}}function y(t,c,e){var p=this;this.startX=t/2,this.startY=c,this.isFrozen=!1,this.color=e.nextInRange(y.prototype.parameters.colors.length),this.type=e.nextInRange(y.prototype.parameters.types.length),this.orientaion=e.nextInRange(y.prototype.parameters.orientations.length),this.bricks=[],this.draw=function(e){p.bricks.forEach(function(t){return t.draw(e)})},this.performAction=function(t){switch(t){case y.prototype.actions.ROTATE:"O"!==y.prototype.parameters.types[p.type].name&&(p.orientaion=3===p.orientaion?0:++p.orientaion,p.applyOrientation());break;case y.prototype.actions.FALL:p.bricks.forEach(function(t){t.y+=c});break;case y.prototype.actions.MOVE_RIGHT:case y.prototype.actions.MOVE_LEFT:for(var e=0;e<4;++e)t===y.prototype.actions.MOVE_LEFT?p.bricks[e].x-=c:p.bricks[e].x+=c;break;case y.prototype.actions.DROP:}return p},this.applyOrientation=function(){for(var t=y.prototype.parameters.types[p.type].matrix,e=y.prototype.parameters.orientations[p.orientaion].matrix,r=[],o=0;o<3;++o){r[o]=[];for(var n=0;n<2;++n)for(var i=r[o][n]=0;i<2;++i)r[o][n]+=t[o][i]*e[i][n]}for(var a=p.bricks[0],s=0;s<3;++s)p.bricks[s+1].x=a.x+r[s][0]*c,p.bricks[s+1].y=a.y+r[s][1]*c;return p};for(var r=0;r<4;++r)this.bricks.push(new o(this.startX,this.startY,y.prototype.parameters.colors[this.color].rgb,c));return this.applyOrientation(),this}function l(s,c,p,u,t){var h=this,e="rgb(69,90,100)",r="rgba(69,90,100,0.12)";this.spawnShape=function(){return new y(c,u,t)},this.activeShape=this.spawnShape(),this.staticBricks=[],this.drawStaticBricks=function(e){h.staticBricks.forEach(function(t){return t.draw(e)})},this.drawBackground=function(t){t.fillStyle=s.turboMode?r:e,t.fillRect(0,0,c,p)},this.drawReplay=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("REPLAY...",0,20)},this.drawScore=function(t){t.fillStyle="white",t.font="12px Courier",t.fillText("Score: "+s.playerScore.get(),0,10)},this.isFull=function(){return h.staticBricks.some(function(t){return t.y<2*u})},this.checkFilledRegions=function(){for(var t=[],r=void 0,o=0,e=function(e){r=h.staticBricks.filter(function(t){return t.y===e}),t.push({bricks:r,isFull:r.length===c/u}),o+=r.length},n=p-u;o!==h.staticBricks.length;n-=u)e(n);var i=[],a=0;for(n=0;n<t.length;++n)t[n].isFull?(t[n].bricks=[],++a,s.playerScore.add(a)):t[n].bricks.forEach(function(t){t.y+=a*u}),i=i.concat(t[n].bricks);h.staticBricks=i},this.checkCollisions=function(t){var r=Object.seal({left:!1,right:!1,bottom:!1}),o=function(t,o){return function(e){if("board"!==t){var r=!1;return h.staticBricks.forEach(function(t){switch(o){case"bottom":r=r||e.y===t.y-u&&e.x===t.x;break;case"left":r=r||e.y===t.y&&e.x-u===t.x;break;case"right":r=r||e.y===t.y&&e.x+u===t.x}}),r}switch(o){case"bottom":return e.y===p-u;case"left":return 0===e.x;case"right":return e.x===c-u}}};h.activeShape.bricks.forEach(function(e){["bottom","left","right"].forEach(function(t){(o("board",t)(e)||o("static",t)(e))&&(r[t]=!0)})}),t(r)}}function d(t,e,r,o){var n;return _defineProperty(n={},t,y.prototype.actions.MOVE_LEFT),_defineProperty(n,e,y.prototype.actions.MOVE_RIGHT),_defineProperty(n,r,y.prototype.actions.ROTATE),_defineProperty(n,o,y.prototype.actions.DROP),n}function b(o){var n=Object.seal(Object.assign({Escape:!1,Enter:!1,anyKey:!1},o));Object.keys(n).forEach(function(t){return!1});var i={},a=[];function t(t){var e="keydown"===t.type,r=t.code;(n.anyKey=e)&&void 0!==i.anyKey&&i.anyKey(r),void 0!==n[r]&&(t.preventDefault(),(n[r]=e)&&(r in o&&a.push(r),void 0!==i[r]&&i[r]()))}return{keys:n,keyMap:o,keyQueue:a,start:function(){addEventListener("keyup",t),addEventListener("keydown",t)},stop:function(){removeEventListener("keyup",t),removeEventListener("keydown",t)},setCallback:function(t,e){i[t]=e}}}function m(t,e){var r=[],o=1/0,n=function(){t.setCallback("anyKey",function(t){r.push({key:t,frame:e.getFrameCount()})}),t.setCallback("Escape",function(){t.stop(),o=e.getFrameCount(),i(),r.pop(),a(),e.restart(),e.setRandomSeed(+new Date)})},i=function(){t.setCallback("anyKey",void 0),t.setCallback("Escape",void 0)},a=function(){e.onProceed=function(){e.getFrameCount()!==o?(e.drawReplay(),r.length&&e.getFrameCount()===r[0].frame&&t.keyQueue.push(r.shift().key)):(e.onProceed=void 0,t.start(),n(),e.restart())}};return{tape:r,lastFrame:o,start:n,stop:i,play:a}}return y.prototype.parameters=Object.freeze({types:[{name:"I",matrix:[[0,-1],[0,1],[0,2]]},{name:"O",matrix:[[0,1],[1,0],[1,1]]},{name:"Z",matrix:[[0,-1],[-1,0],[1,-1]]},{name:"S",matrix:[[-1,-1],[0,-1],[1,0]]},{name:"T",matrix:[[1,0],[-1,0],[0,1]]},{name:"J",matrix:[[1,0],[-1,0],[-1,1]]},{name:"L",matrix:[[1,0],[-1,0],[-1,-1]]}],orientations:[{angle:0,matrix:[[1,0],[0,1]]},{angle:90,matrix:[[0,-1],[1,0]]},{angle:180,matrix:[[-1,0],[0,-1]]},{angle:270,matrix:[[0,1],[-1,0]]}],colors:[{name:"orange",rgb:"rgb(239,108,0)"},{name:"red",rgb:"rgb(211,47,47)"},{name:"green",rgb:"rgb(76,175,80)"},{name:"blue",rgb:"rgb(33,150,243)"},{name:"yellow",rgb:"rgb(255,235,59)"},{name:"cyan",rgb:"rgb(0,188,212)"},{name:"pink",rgb:"rgb(233,30,99)"},{name:"white",rgb:"rgb(224,224,224)"}]}),y.prototype.actions=Object.freeze({ROTATE:"rotate",MOVE_LEFT:"move-left",MOVE_RIGHT:"move-right",FALL:"fall",DROP:"drop"}),function(n){var e,t,r=this,o=n.context,i=[new d("ArrowLeft","ArrowRight","ArrowUp","ArrowDown"),new d("KeyA","KeyD","KeyW","KeyS"),new d("KeyH","KeyL","KeyK","KeyJ")],a=new b(Object.assign.apply(Object,i)),s=new m(a,this);a.start(),s.start(),this.randomSeed=+new Date,this.random=new f(this.randomSeed),this.playerScore=(t=[149,49,39,9,e=0],{get:function(){return e},set:function(r){e=r,t.some(function(t,e){if(t<=r)return u=5-e,!0})},add:function(t){this.set(e+t)}});var c=new l(this,n.board.boardWidth,n.board.boardHeight,n.board.brickSize,this.random),p=0;this.onProceed=void 0;var u=1;this.turboMode=!1,this.drawReplay=function(){c.drawReplay(o)},this.getFrameCount=function(){return p},this.restart=function(){r.random=new f(r.randomSeed),r.playerScore.set(0),p=0,u=1,r.turboMode=!1,c=new l(r,n.board.boardWidth,n.board.boardHeight,n.board.brickSize,r.random)},this.setRandomSeed=function(t){r.randomSeed=t};var h=function(e){c.checkCollisions(function(t){switch(c.activeShape.isFrozen=t.bottom,!0){case e===y.prototype.actions.ROTATE&&function(){var t=c.spawnShape();t.orientaion=c.activeShape.orientaion,t.type=c.activeShape.type;for(var e=0;e<4;++e)Object.assign(t.bricks[e],c.activeShape.bricks[e]);t.performAction(y.prototype.actions.ROTATE);for(var r=0;r<4;++r){for(var o=0;o<c.staticBricks.length;++o)if(t.bricks[r].x===c.staticBricks[o].x&&t.bricks[r].y===c.staticBricks[o].y)return!0;if(t.bricks[r].x>=n.board.boardWidth||t.bricks[r].x<=0||t.bricks[r].y>=n.board.boardHeight)return!0}return!1}():case e===y.prototype.actions.MOVE_RIGHT&&t.right:case e===y.prototype.actions.MOVE_LEFT&&t.left:case e===y.prototype.actions.FALL&&t.bottom:case e===y.prototype.actions.DROP&&t.bottom:break;default:e===y.prototype.actions.DROP&&(r.turboMode=!0),c.activeShape.performAction(e)}})};this.proceed=function(){var t;if(++p,c.drawBackground(o),void 0!==r.onProceed&&r.onProceed(),t=a.keyQueue.shift(),h(a.keyMap[t]),c.checkCollisions(function(t){c.activeShape.isFrozen=t.bottom}),c.activeShape.isFrozen){for(var e=0;e<4;++e)c.staticBricks.push(c.activeShape.bricks.pop());c.checkFilledRegions(),r.turboMode=!1,c.activeShape=c.spawnShape(),c.isFull()&&r.restart()}else(r.turboMode||p%[null,27,24,16,12,8][u]==0)&&h(y.prototype.actions.FALL),c.activeShape.draw(o);c.drawStaticBricks(o),c.drawScore(o)},requestAnimationFrame(function t(){r.proceed(),requestAnimationFrame(t)})}}();